<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
  </head>
  <style>
    body {
      font-family: Arial Unicode MS, Lucida Sans Unicode, Code2000, sans-serif;
      font-size: 24px;
      max-width: 1700px;
      margin: auto;
      margin-left: 1%;
      margin-right: 1%;
      display: grid;
      height: 100vh;
      grid-template-rows: 20fr minmax(0, 1fr);
      grid-template-areas: 
        "chat"
        "bottom"
    }
    #logo {
      font-size: 36px;
      text-align: center;
    }
    select,
    button {
      font-family: Arial Unicode MS, Lucida Sans Unicode, Code2000, sans-serif;
      font-size: 14px;
    }
    #stupidStuff,
    #stupidStuff select,
    #stupidStuff button {
      font-size: 14px;
    }
    .leftDiv {
      float: left;
      clear: both;
      max-width: 50%;
    }
    .leftMes {
      text-align: left;
    }
    .rightDiv {
      float: right;
      clear: both;
      max-width: 50%;
    }
    .rightMes {
      text-align: left;
    }
    .hidden {
      display: none;
    }
    #chat {
      overflow-y: scroll;
      grid-area: chat;
    }
    #bottom {
      clear: both;
      grid-area: bottom;
    }
    @media (min-width: 1200px) {
      .leftDiv {
        max-width: 700px;
      }
      .rightDiv {
        max-width: 700px;
      }
    }
  </style>
  <body>
    <style>
      body {
        font-family: Arial Unicode MS, Lucida Sans Unicode, Code2000, sans-serif;
        font-size: 24px;
        max-width: 1700px;
        margin: auto;
        margin-left: 1%;
        margin-right: 1%;
      }
      select,
      button {
        font-family: Arial Unicode MS, Lucida Sans Unicode, Code2000, sans-serif;
        font-size: 14px;
      }
      #stupidStuff,
      #stupidStuff select,
      #stupidStuff button {
        font-size: 14px;
      }
      .leftDiv {
        float: left;
        clear: both;
        max-width: 50%;
      }
      .leftMes {
        text-align: left;
      }
      .rightDiv {
        float: right;
        clear: both;
        max-width: 50%;
      }
      .rightMes {
        text-align: left;
      }
      .hidden {
        display: none;
      }
      #bottom {
        clear: both;
      }
      @media (min-width: 1200px) {
        .leftDiv {
          max-width: 700px;
        }
        .rightDiv {
          max-width: 700px;
        }
      }
    </style>
    <script>
      var localConnection;
      var remoteConnection;
      var sendChannel;
      var userType;
      function generateOffer() {
        userType = 'sender';
        const iceConfiguration = { }
        iceConfiguration.iceServers = [];
        iceConfiguration.iceServers.push({
          urls: 'turn:turn.lincolnnguyen18.com',
          username: 'guest',
          credential: 'somepassword'
        })
        iceConfiguration.iceServers.push({
          urls: 'stun:stun.lincolnnguyen18.com'
        })
        localConnection = new RTCPeerConnection(iceConfiguration)
        localConnection.onicecandidate = e =>  {
          console.log(" NEW ice candidnat!! on localconnection reprinting SDP " )
          console.log(JSON.stringify(localConnection.localDescription))
          document.getElementById('offer').innerHTML = JSON.stringify(localConnection.localDescription);
        }
        sendChannel = localConnection.createDataChannel("sendChannel");
        sendChannel.onmessage = e =>  {
          console.log("messsage received!!!"  + e.data );
          data = JSON.parse(e.data);
          if (data['type'] == 'interim') {
            document.getElementById('interim2').innerHTML = `<div class='rightDiv'><p class='rightMes'>${data['message']}</p></div>`;
          } else if (data['type'] == 'final') {
            document.getElementById('final').innerHTML += `<div class='rightDiv'><p class='rightMes'>${data['message']}</p></div>`;
          }
        }
        sendChannel.onopen = e => {
          console.log("open!!!!");
          document.getElementById('stupidStuff').remove();
          document.getElementById('chat').classList.remove('hidden');
        }
        sendChannel.onclose =e => console.log("closed!!!!!!");
        localConnection.createOffer().then(function(o) {
          localConnection.setLocalDescription(o);
        });
      }
      async function generateAnswer() {
        userType = 'receiver';
        const offer = JSON.parse(document.getElementById('offerTextarea').value);
        remoteConnection = new RTCPeerConnection()

        remoteConnection.onicecandidate = e =>  {
        console.log(" NEW ice candidnat!! on localconnection reprinting SDP " )
         console.log(JSON.stringify(remoteConnection.localDescription) )
        }

        remoteConnection.ondatachannel= e => {
              const receiveChannel = e.channel;
              receiveChannel.onmessage = e =>  {
                console.log("messsage received!!!"  + e.data );
                data = JSON.parse(e.data);
                if (data['type'] == 'interim') {
                  document.getElementById('interim2').innerHTML = `<div class='rightDiv'><p class='rightMes'>${data['message']}</p></div>`;
                } else if (data['type'] == 'final') {
                  document.getElementById('final').innerHTML += `<div class='rightDiv'><p class='rightMes'>${data['message']}</p></div>`;
                }
              }
              receiveChannel.onopen = e => {
                console.log("open!!!!");
                document.getElementById('stupidStuff').remove();
                document.getElementById('chat').classList.remove('hidden');
              }
              receiveChannel.onclose =e => console.log("closed!!!!!!");
              remoteConnection.channel = receiveChannel;
        }

        remoteConnection.setRemoteDescription(offer).then(a=>console.log("done"))

        //create answer
        await remoteConnection.createAnswer().then(a => remoteConnection.setLocalDescription(a)).then(a=> {
          console.log(JSON.stringify(remoteConnection.localDescription));
          document.getElementById('answer').innerHTML = JSON.stringify(remoteConnection.localDescription);
        });
        //send the anser to the client
      }
      function setAnswer() {
        const answer = JSON.parse(document.getElementById('answerTextarea').value);
        localConnection.setRemoteDescription (answer).then(a=>console.log("done"));
      }
      function updateInterim(message) {
        data = {
          type: 'interim',
          message: message
        }
        data = JSON.stringify(data);
        if (userType == 'sender') {
          sendChannel.send(data);
        } else {
          remoteConnection.channel.send(data);
        }
      }
      function sendFinal(message) {
        document.getElementById('final').innerHTML += `<div class='leftDiv'><p class='leftMes'>${message}</p></div>`;
        data = {
          type: 'final',
          message: message
        }
        data = JSON.stringify(data);
        if (userType == 'sender') {
          sendChannel.send(data);
        } else {
          remoteConnection.channel.send(data);
        }
      }
    </script>
    <div id="chat" class="">
        <div id='logo'>
        <h1 id='logo'>WeeSpeak</h1>
      </div>
      <div>
        <p id="final"><div class="leftDiv"><p class="leftMes">Hello friends hello everybody this is pretty great isn't it</p></div><div class="leftDiv"><p class="leftMes">Zeta sorry. Is a test 1 2 3 4 5 8 s a b c d e f g let's read some stuff on Bloomberg shall we to fill in the stupid gas 1 2 3 4 5 fed officials battle rate hike saber as price special surprise and measures taken unawares by the dock.</p></div><div class="leftDiv"><p class="leftMes"> 2023 highest Powerball says there's</p></div><div class="leftDiv"><p class="leftMes"> 70 / inflation</p></div><div class="leftDiv"><p class="leftMes"> Federal Reserve officials have said for months that price increases are temporary on Wednesday they weren't so sure is there a risk that inflation will be harder than we think yesterday Jerome purple out a press conference</p></div><div class="leftDiv"><p class="leftMes">ha ordinato una pizza</p></div><div class="leftDiv"><p class="leftMes">test test test one two three four five</p></div><div class="leftDiv"><p class="leftMes"> are Akitas a testis latest</p></div><div class="leftDiv"><p class="leftMes"> stars are going to fall socks are going to ride to REI</p></div><div class="leftDiv"><p class="leftMes"> it has great is awesome</p></div></p>
      </div>
      <div>
        <p id="interim"></p>
        <p id="interim2" style="color:grey"></p>
      </div>
      <div class="leftDiv">
        <span id="final_span"></span>
        <span id="interim_span" style="color:grey"></span>
      </div>
    </div>
  <div id="bottom">
      <select id="selectLang">
        <option value="af-ZA">Afrikaans</option>
        <option value="id-ID">Bahasa Indonesia</option>
        <option value="ms-MY">Bahasa Melayu</option>
        <option value="ca-ES">Català</option>
        <option value="cs-CZ">Čeština</option>
        <option value="de-De">Deutsch</option>
        <option value="en-AU">English (Australia)</option>
        <option value="en-CA">English (Canada)</option>
        <option value="en-IN">English (India)</option>
        <option value="en-NZ">English (New Zealand)</option>
        <option value="en-ZA">English (South Africa)</option>
        <option value="en-GB">English (United Kingdom)</option>
        <option value="en-US">English (United States)</option>
        <option value="es-AR">Español (Argentina)</option>
        <option value="es-BO">Español (Bolivia)</option>
        <option value="es-CL">Español (Chile)</option>
        <option value="es-CO">Español (Colombia)</option>
        <option value="es-CR">Español (Costa Rica)</option>
        <option value="es-EC">Español (Ecuador)</option>
        <option value="es-SV">Español (El Salvador)</option>
        <option value="es-ES">Español (España)</option>
        <option value="es-US">Español (Estados Unidos)</option>
        <option value="es-GT">Español (Guatemala)</option>
        <option value="es-HN">Español (Honduras)</option>
        <option value="es-MX">Español (México)</option>
        <option value="es-NI">Español (Nicaragua)</option>
        <option value="es-PA">Español (Panamá)</option>
        <option value="es-PY">Español (Paraguay)</option>
        <option value="es-PE">Español (Perú)</option>
        <option value="es-PR">Español (Puerto Rico)</option>
        <option value="es-DO">Español (República Dominicana)</option>
        <option value="es-UY">Español (Uruguay)</option>
        <option value="es-VE">Español (Venezuela)</option>
        <option value="eu-ES">Euskara</option>
        <option value="fr-FR">Français</option>
        <option value="gl-ES">Galego</option>
        <option value="hr-HR">Hrvatski</option>
        <option value="zu-ZA">IsiZulu</option>
        <option value="is-IS">Íslenska</option>
        <option value="it-IT">Italiano (Italia)</option>
        <option value="it-CH">Italiano (Svizzera)</option>
        <option value="hu-HU">Magyar</option>
        <option value="nl-NL">Nederlands</option>
        <option value="nb-NO">Norsk bokmål</option>
        <option value="pl-PL">Polski</option>
        <option value="pt-BR">Português (Brasil)</option>
        <option value="pt-PT">Português (Portugal)</option>
        <option value="ro-RO">Română</option>
        <option value="sk-SK">Slovenčina</option>
        <option value="fi-FI">Suomi</option>
        <option value="sv-SE">Svenska</option>
        <option value="tr-TR">Türkçe</option>
        <option value="bg-BG">български</option>
        <option value="ru-RU">Pусский</option>
        <option value="sr-RS">Српски</option>
        <option value="ko-KR">한국어</option>
        <option value="cmn-Hans-CN">中文 普通话 (中国大陆)</option>
        <option value="cmn-Hans-HK">中文 普通话 (香港)</option>
        <option value="cmn-Hant-TW">中文 中文 (台灣)</option>
        <option value="yue-Hant-HK">中文 粵語 (香港)</option>
        <option value="ja-JP">日本語</option>
        <option value="la">Lingua latīna</option>
      </select>
      <button id="button" onclick="toggleStartStop()">Click to Speak</button>
      <script type="text/javascript">
        selectLang = document.getElementById('selectLang');
        selectLang.selectedIndex = "12";

        var recognizing;
        var recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        reset();
        recognition.onend = reset;

        recognition.onresult = function (event) {
          var final = "";
          var interim = "";
          for (var i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
              fragment = event.results[i][0].transcript;
              final += fragment;
              if (i == event.results.length - 1) {
                sendFinal(fragment);
              }
            } else {
              interim += event.results[i][0].transcript;
            }
          }
          // final_span.innerHTML = final;
          interim_span.innerHTML = interim;
          updateInterim(interim);
        }

        function reset() {
          recognizing = false;
          button.innerHTML = "Click to Speak";
        }

        function toggleStartStop() {
          if (recognizing) {
            recognition.stop();
            reset();
          } else {
            recognition.lang = selectLang.value;
            recognition.start();
            recognizing = true;
            button.innerHTML = "Click to Stop";
            final_span.innerHTML = "";
            interim_span.innerHTML = "";
          }
        }
      </script>
    </div>
</body>
</html>
