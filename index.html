<script src="//unpkg.com/alpinejs" defer></script>
<!--
<div x-data="{tweet: 'Say something!'}">
  <textarea x-model="tweet"></textarea>
  <div x-text="tweet"></div>
</div>
-->
<script>
  var localConnection;
  var remoteConnection;
  var sendChannel;
  var userType;
  function generateOffer() {
    userType = 'sender';
    const iceConfiguration = { }
    iceConfiguration.iceServers = [];
    iceConfiguration.iceServers.push({
      urls: 'turn:turn.lincolnnguyen18.com',
      username: 'guest',
      credential: 'somepassword'
    })
    iceConfiguration.iceServers.push({
      urls: 'stun:stun.lincolnnguyen18.com'
    })
    localConnection = new RTCPeerConnection(iceConfiguration)
    localConnection.onicecandidate = e =>  {
      console.log(" NEW ice candidnat!! on localconnection reprinting SDP " )
      console.log(JSON.stringify(localConnection.localDescription))
      document.getElementById('offer').innerHTML = JSON.stringify(localConnection.localDescription);
    }
    sendChannel = localConnection.createDataChannel("sendChannel");
    sendChannel.onmessage = e =>  {
      console.log("messsage received!!!"  + e.data );
      data = JSON.parse(e.data);
      if (data['type'] == 'interim') {
        document.getElementById('interim').innerHTML = data['message'];
      } else if (data['type'] == 'final') {
        document.getElementById('final').innerHTML += data['message'];
      }
    }
    sendChannel.onopen = e => {
      console.log("open!!!!");
      alert('Channel opened!');
    }
    sendChannel.onclose =e => console.log("closed!!!!!!");
    localConnection.createOffer().then(function(o) {
      localConnection.setLocalDescription(o);
    });
  }
  async function generateAnswer() {
    userType = 'receiver';
    const offer = JSON.parse(document.getElementById('offerTextarea').value);
    remoteConnection = new RTCPeerConnection()

    remoteConnection.onicecandidate = e =>  {
    console.log(" NEW ice candidnat!! on localconnection reprinting SDP " )
     console.log(JSON.stringify(remoteConnection.localDescription) )
    }

    remoteConnection.ondatachannel= e => {
          const receiveChannel = e.channel;
          receiveChannel.onmessage = e =>  {
            console.log("messsage received!!!"  + e.data );
            data = JSON.parse(e.data);
            if (data['type'] == 'interim') {
              document.getElementById('interim').innerHTML = data['message'];
            } else if (data['type'] == 'final') {
              document.getElementById('final').innerHTML += data['message'];
            }
          }
          receiveChannel.onopen = e => {
            console.log("open!!!!");
            alert('Channel opened!');
          }
          receiveChannel.onclose =e => console.log("closed!!!!!!");
          remoteConnection.channel = receiveChannel;
    }

    remoteConnection.setRemoteDescription(offer).then(a=>console.log("done"))

    //create answer
    await remoteConnection.createAnswer().then(a => remoteConnection.setLocalDescription(a)).then(a=> {
      console.log(JSON.stringify(remoteConnection.localDescription));
      document.getElementById('answer').innerHTML = JSON.stringify(remoteConnection.localDescription);
    });
    //send the anser to the client
  }
  function setAnswer() {
    const answer = JSON.parse(document.getElementById('answerTextarea').value);
    localConnection.setRemoteDescription (answer).then(a=>console.log("done"));
  }
  function updateInterim(message) {
    data = {
      type: 'interim',
      message: message
    }
    data = JSON.stringify(data);
    if (userType == 'sender') {
      sendChannel.send(data);
    } else {
      remoteConnection.channel.send(data);
    }
  }
  function sendFinal(message) {
    data = {
      type: 'final',
      message: message
    }
    data = JSON.stringify(data);
    if (userType == 'sender') {
      sendChannel.send(data);
    } else {
      remoteConnection.channel.send(data);
    }
  }
</script>
<div x-data="{ count: 0 }">
    <button x-on:click="count = generateOffer()">Generate Offer</button>
    <h1>COPY OFFER</h1>
    <p id="offer">COPY OFFER HERE</p>
    <h1>COPY ANSWER</h1>
    <p id="answer">COPY ANSWER HERE</p>
</div>
<div x-data="{ }">
  <h1>PASTE OFFER</h1>
  <textarea id="offerTextarea">PASTE OFFER HERE</textarea>
  <br />
  <button x-on:click=generateAnswer()>Submit</button>
</div>
<div x-data="{ }">
  <h1>PASTE ANSWER</h1>
  <textarea id="answerTextarea">PASTE ANSWER HERE</textarea>
  <br />
  <button x-on:click=setAnswer()>Submit</button>
</div>
<div>
  <h1>SEND MESSAGE</h1>
  <button id="button" onclick="toggleStartStop()">BUTTON</button>
  <div style="border:dotted;padding:10px">
    <span id="final_span"></span>
    <span id="interim_span" style="color:grey"></span>
  </div>
  <script type="text/javascript">
    var recognizing;
    var recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    reset();
    recognition.onend = reset;

    recognition.onresult = function (event) {
      var final = "";
      var interim = "";
      for (var i = event.resultIndex; i < event.results.length; ++i) {
        if (event.results[i].isFinal) {
          fragment = event.results[i][0].transcript;
          final += fragment;
          if (i == event.results.length - 1) {
            sendFinal(fragment);
          }
        } else {
          interim += event.results[i][0].transcript;
        }
      }
      final_span.innerHTML = final;
      interim_span.innerHTML = interim;
      updateInterim(interim);
    }

    function reset() {
      recognizing = false;
      button.innerHTML = "Click to Speak";
    }

    function toggleStartStop() {
      if (recognizing) {
        recognition.stop();
        reset();
      } else {
        recognition.start();
        recognizing = true;
        button.innerHTML = "Click to Stop";
        final_span.innerHTML = "";
        interim_span.innerHTML = "";
      }
    }
  </script>
</div>
<div>
  <h1>INTERIM MESSAGE</h1>
  <p id="interim"></p>
</div>
<div>
  <h1>FINAL MESSAGES</h1>
  <p id="final"></p>
</div>
